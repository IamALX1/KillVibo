<!-- Instructions for embedding:
1. Copy and paste this ENTIRE block of code into your webpage's HTML where you want the component to appear.
2. This snippet includes the necessary links to fonts and styles.
3. The "Add" button functionality is now configured to send data to a specific webhook URL.
-->

<!-- Required Styles and Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Scoping styles to the component to avoid conflicts */
    #spotify-search-container {
        font-family: 'Inter', sans-serif;
        background-color: #191414; /* Spotify Black */
        color: #FFFFFF;
    }
    #spotify-search-container ::-webkit-scrollbar { width: 8px; }
    #spotify-search-container ::-webkit-scrollbar-track { background: #282828; }
    #spotify-search-container ::-webkit-scrollbar-thumb { background: #535353; border-radius: 10px; }
    #spotify-search-container ::-webkit-scrollbar-thumb:hover { background: #737373; }
    #spotify-search-container select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20127.9c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4L287%2095.2c3.6-3.7%205.4-8%205.4-13%200-4.9-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 0.7rem center;
        background-size: 0.65rem auto;
    }
    #spotify-search-container .player-container {
        transition: max-height 0.5s ease-in-out;
        max-height: 0;
        overflow: hidden;
    }
    #spotify-search-container .player-container.is-open {
        max-height: 100px; /* Enough height for the compact player */
    }
</style>

<!-- Main Component HTML -->
<div id="spotify-search-container" class="w-full max-w-3xl mx-auto bg-[#282828] rounded-2xl shadow-2xl shadow-black/30 overflow-hidden">
    <div class="p-4 sm:p-6 md:p-8">
        <!-- Spotify Logo -->
        <svg role="img" class="h-8 w-8 sm:h-10 sm:w-10 mx-auto mb-4 text-white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Spotify</title><path fill="#1DB954" d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm6.825 17.54c-.23.36-.69.48-1.05.25-2.7-1.66-6.25-2.05-10.4-1.15-.42.1-.84-.13-1.04-.54-.2-.41.13-.84.54-1.04 4.5-1 8.35-.55 11.35 1.35.36.22.48.69.25 1.05zm1.2-2.7c-.28.45-.88.6-1.33.32-3.15-1.95-7.6-2.5-12.25-1.35-.53.15-1.08-.18-1.23-.7-.15-.53.18-1.08.7-1.23C14.35 9.9 19.2 10.5 22.75 12.7c.45.28.6.88.32 1.33zm.1-3.2c-3.75-2.15-9.8-2.4-14.4-1.25-.6.15-1.2-.2-1.35-.8-.15-.6.2-1.2.8-1.35C11.25 4.9 17.9 5.2 22.1 7.6c.55.3.7 1 .4 1.55-.3.55-1 .7-1.55.4z"/></svg>
        
        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-center text-white mb-6">
            Project: KillVibo <br> [Beta 1.3 Deployment]
        </h1>

        <!-- Search Controls -->
        <div class="flex flex-col sm:flex-row items-center gap-2 sm:gap-4">
            <div class="relative flex-grow w-full">
                <input type="text" id="searchInput" placeholder="Enter a song name..." class="w-full text-sm sm:text-base pl-10 sm:pl-12 pr-4 py-3 bg-[#333333] border-2 border-[#535353] rounded-xl focus:ring-2 focus:ring-[#1DB954] focus:border-[#1DB954] focus:outline-none transition duration-300 placeholder-gray-400">
                <svg class="absolute left-3 sm:left-4 top-1/2 -translate-y-1/2 w-5 h-5 sm:w-6 sm:h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <div class="flex-shrink-0 w-full sm:w-auto">
                <select id="resultsCount" class="w-full h-full text-sm sm:text-base px-4 py-3 bg-[#333333] border-2 border-[#535353] rounded-xl focus:ring-2 focus:ring-[#1DB954] focus:border-[#1DB954] focus:outline-none transition duration-300">
                    <option value="5">5 Results</option>
                    <option value="10" selected>10 Results</option>
                    <option value="15">15 Results</option>
                    <option value="20">20 Results</option>
                    <option value="25">25 Results</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results" class="px-2 pb-4">
        <div id="loader" class="hidden justify-center items-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#1DB954]"></div></div>
        <div id="no-results" class="hidden text-center p-8 text-gray-400"><p>No results found. Try another search.</p></div>
        <div id="initial-message" class="text-center p-8 text-gray-400"><p>Your search results will appear here.</p></div>
    </div>
</div>

<!-- Main Component Script -->
<script>
    // Self-invoking function to encapsulate the script and avoid global scope conflicts
    (function() {
        // --- Spotify API Credentials ---
        const clientId = '65b6fcd844db4cb2804723a8f4379eb7';
        const clientSecret = 'ee49545485ba402f87166553e242da14';
        let accessToken = null;
        let tokenExpirationTime = 0;

        // --- DOM Elements ---
        const searchContainer = document.getElementById('spotify-search-container');
        const searchInput = searchContainer.querySelector('#searchInput');
        const resultsCount = searchContainer.querySelector('#resultsCount');
        const resultsContainer = searchContainer.querySelector('#results');
        const loader = searchContainer.querySelector('#loader');
        const noResultsMessage = searchContainer.querySelector('#no-results');
        const initialMessage = searchContainer.querySelector('#initial-message');

        let searchTimeout;

        /** Fetches a new access token from the Spotify API. */
        async function getAccessToken() {
            if (accessToken && Date.now() < tokenExpirationTime) return accessToken;
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
                    },
                    body: 'grant_type=client_credentials'
                });
                if (!response.ok) throw new Error(`Token fetch failed: ${response.statusText}`);
                const data = await response.json();
                accessToken = data.access_token;
                tokenExpirationTime = Date.now() + (data.expires_in - 60) * 1000;
                return accessToken;
            } catch (error) {
                console.error("Error fetching Spotify access token:", error);
                resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">Could not connect to Spotify.</p>`;
                return null;
            }
        }

        /** Searches for tracks and their audio features on Spotify. */
        async function searchSongs() {
            const query = searchInput.value;
            if (!query.trim()) {
                clearResults(true);
                return;
            }
            clearResults();
            loader.style.display = 'flex';

            const token = await getAccessToken();
            if (!token) {
                loader.style.display = 'none';
                return;
            }

            try {
                // Step 1: Search for tracks
                const limit = resultsCount.value;
                const searchUrl = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=${limit}`;
                const searchResponse = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                
                if (searchResponse.status === 401) {
                    accessToken = null;
                    console.log("Token expired on search, retrying...");
                    searchSongs(); // Retry the whole function
                    return;
                }
                if (!searchResponse.ok) throw new Error(`Search API error: ${searchResponse.statusText}`);
                
                const searchData = await searchResponse.json();
                const tracks = searchData.tracks.items;

                if (!tracks || tracks.length === 0) {
                    displayResults([]);
                    return;
                }

                // Step 2: Get audio features (BPM)
                let combinedData;
                try {
                    const trackIds = tracks.map(track => track && track.id).filter(Boolean).join(',');
                    if (trackIds) {
                        const featuresUrl = `https://api.spotify.com/v1/audio-features?ids=${trackIds}`;
                        const featuresResponse = await fetch(featuresUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (featuresResponse.status === 401) {
                            accessToken = null;
                            console.log("Token expired on features fetch, retrying...");
                            searchSongs();
                            return;
                        }
                        if (!featuresResponse.ok) {
                            throw new Error(`Features API error: Status ${featuresResponse.status}`);
                        }
                        const featuresData = await featuresResponse.json();
                        const audioFeaturesMap = new Map(featuresData.audio_features.map(f => f && [f.id, f]).filter(Boolean));
                        combinedData = tracks.map(track => ({
                            ...track,
                            bpm: (audioFeaturesMap.get(track.id)?.tempo || 0)
                        }));
                    } else {
                        // If no track IDs, just set bpm to 0
                        combinedData = tracks.map(t => ({...t, bpm: 0}));
                    }
                } catch (featuresError) {
                    // If fetching features fails for any reason (like 403), log it and proceed without BPM
                    console.warn("Could not fetch audio features:", featuresError.message);
                    console.warn("Displaying results without BPM data.");
                    combinedData = tracks.map(t => ({...t, bpm: 0}));
                }

                displayResults(combinedData);

            } catch (error) {
                console.error("Error during Spotify search:", error);
                loader.style.display = 'none';
                resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">An error occurred. Please try again.</p>`;
            }
        }

        /** Renders the search results in the DOM. */
        function displayResults(tracks) {
            clearResults();

            if (!tracks || tracks.length === 0) {
                noResultsMessage.style.display = 'block';
                return;
            }
            
            tracks.sort((a, b) => b.popularity - a.popularity);

            tracks.forEach(track => {
                const artists = track.artists.map(artist => artist.name).join(', ');
                const albumArtUrl = track.album.images.length ? track.album.images[0].url : 'https://placehold.co/48x48/282828/737373?text=N/A';
                const songUrl = track.external_urls.spotify;
                const bpm = Math.round(track.bpm);

                const resultElement = document.createElement('div');
                resultElement.className = 'result-item p-3 mx-2 mb-2 bg-[#333333]/60 rounded-lg transition-all duration-300';
                resultElement.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${albumArtUrl}" class="w-10 h-10 sm:w-12 sm:h-12 rounded-md flex-shrink-0" alt="${track.album.name}" onerror="this.src='https://placehold.co/48x48/282828/737373?text=N/A'">
                        <div class="min-w-0 flex-grow">
                            <p class="font-bold truncate text-sm sm:text-base text-white">${track.name}</p>
                            <div class="flex items-center gap-x-2">
                                <p class="text-xs sm:text-sm text-gray-400 truncate">${artists}</p>
                                <p class="text-xs sm:text-sm text-gray-400 flex-shrink-0">· ${bpm} BPM</p>
                            </div>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                             <button class="add-button flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-blue-500 rounded-full hover:bg-blue-400 transition-transform duration-200 hover:scale-110" 
                                data-track-name="${encodeURIComponent(track.name)}"
                                data-artists="${encodeURIComponent(artists)}"
                                data-song-url="${encodeURIComponent(songUrl)}"
                                data-album-art-url="${encodeURIComponent(albumArtUrl)}"
                                data-bpm="${bpm}">
                                <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button class="play-button flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-[#1DB954] rounded-full hover:bg-green-500 transition-transform duration-200 hover:scale-110" data-track-id="${track.id}">
                                <svg class="w-5 h-5 text-black" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4.018 15.592A.998.998 0 005 16h10a1 1 0 00.982-1.408L9.982 4.408A1 1 0 008.018 4.408L4.018 15.592z" transform="rotate(90 10 10)"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="player-container-${track.id}" class="player-container mt-2"></div>
                `;
                resultsContainer.appendChild(resultElement);
            });
        }

        /** Toggles the inline compact player. */
        function toggleInlinePlayer(trackId) {
            const playerContainer = searchContainer.querySelector(`#player-container-${trackId}`);
            const isOpen = playerContainer.classList.contains('is-open');
            
            clearAllPlayers(trackId);

            if (isOpen) {
                playerContainer.innerHTML = '';
                playerContainer.classList.remove('is-open');
                updatePlayButtonIcon(trackId, true);
            } else {
                const iframe = document.createElement('iframe');
                iframe.style.borderRadius = '12px';
                iframe.src = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0&autoplay=1`;
                iframe.width = '100%';
                iframe.height = '80';
                iframe.frameBorder = '0';
                iframe.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
                iframe.loading = 'lazy';
                
                playerContainer.appendChild(iframe);
                playerContainer.classList.add('is-open');
                updatePlayButtonIcon(trackId, false);
            }
        }

        /** Clears all player containers except the one specified. */
        function clearAllPlayers(exceptTrackId = null) {
            searchContainer.querySelectorAll('.player-container').forEach(container => {
                const containerId = container.id.replace('player-container-', '');
                if (containerId !== exceptTrackId) {
                    container.innerHTML = '';
                    container.classList.remove('is-open');
                    updatePlayButtonIcon(containerId, true);
                }
            });
        }

        /** Updates the icon on the play button. */
        function updatePlayButtonIcon(trackId, isPlayIcon) {
            const button = searchContainer.querySelector(`.play-button[data-track-id="${trackId}"]`);
            if (!button) return;

            const playIcon = `<svg class="w-5 h-5 text-black" fill="currentColor" viewBox="0 0 20 20"><path d="M4.018 15.592A.998.998 0 005 16h10a1 1 0 00.982-1.408L9.982 4.408A1 1 0 008.018 4.408L4.018 15.592z" transform="rotate(90 10 10)"></path></svg>`;
            const closeIcon = `<svg class="w-5 h-5 text-black" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>`;
            
            button.innerHTML = isPlayIcon ? playIcon : closeIcon;
        }
        
        /** Clears results and status messages. */
        function clearResults(showInitial = false) {
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(loader);
            resultsContainer.appendChild(noResultsMessage);
            resultsContainer.appendChild(initialMessage);
            loader.style.display = 'none';
            noResultsMessage.style.display = 'none';
            initialMessage.style.display = showInitial ? 'block' : 'none';
        }

        /** Get user info from URL parameters */
        function getUserInfo() {
            const params = new URLSearchParams(window.location.search);
            return {
                userID: params.get('userID'),
                userEmail: params.get('userEmail'),
                rowID: params.get('rowID')
            };
        }

        // --- Event Listeners ---
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchSongs();
            }, 300);
        }

        searchInput.addEventListener('keyup', handleSearch);
        resultsCount.addEventListener('change', handleSearch);

        resultsContainer.addEventListener('click', async function(e) {
            const playButton = e.target.closest('.play-button');
            const addButton = e.target.closest('.add-button');

            if (playButton) {
                const trackId = playButton.dataset.trackId;
                toggleInlinePlayer(trackId);
            } else if (addButton) {
                if (addButton.disabled) return; // Prevent multiple clicks

                const userInfo = getUserInfo();
                const webhookUrl = 'https://go.glideapps.com/api/container/plugin/webhook-trigger/HA0F8RNgNXbk4m4rls9b/5f4c7893-9e7d-4857-8f13-27013bc090da';
                const payload = {
                    'Name': decodeURIComponent(addButton.dataset.trackName),
                    'Artist': decodeURIComponent(addButton.dataset.artists),
                    'URL': decodeURIComponent(addButton.dataset.songUrl),
                    'AlbumArt': decodeURIComponent(addButton.dataset.albumArtUrl), // <-- FIX: Removed space from key
                    'BPM': Number(addButton.dataset.bpm),
                    'UserID': userInfo.userID,
                    'UserEmail': userInfo.userEmail,
                    'RowID': userInfo.rowID
                };

                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // Give visual feedback that the song was added
                        addButton.innerHTML = `<svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                        addButton.classList.remove('bg-blue-500', 'hover:bg-blue-400');
                        addButton.classList.add('bg-green-500');
                        addButton.disabled = true;
                    } else {
                        console.error('Webhook failed:', response.status, await response.text());
                        alert(`Failed to add song. Server responded with status ${response.status}.`);
                    }
                } catch (error) {
                    console.error("Error sending webhook:", error);
                    alert("Could not send song data. Please check the console for errors.");
                }
            }
        });

        // Initialize the component
        window.addEventListener('load', getAccessToken);
    })(); // End of self-invoking function
</script>
